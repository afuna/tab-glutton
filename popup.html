<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/css/style.css" type="text/css">
<script type="text/javascript" src="lib/tg.js"></script>
<script>
// Delay filtering for typing speed
var TYPING_DELAY = 350;
// Typing timeout reference
var typing = null;
// Keep track of the current tab item
var current = null;

function load() {
	chrome.tabs.getAllInWindow(null, function(tabs) {
		var content = document.getElementById("content");
		var list = document.getElementById("list");
		var i = 0;

		for (; i < tabs.length ; i++) {
			var li = document.createElement("li");
			li.appendChild(createActions());
			li.appendChild(createLink(tabs[i].favIconUrl, tabs[i].title, tabs[i].url));
			li.appendChild(createDescription(tabs[i].url));
		
			li.tabId = tabs[i].id;
			if (tabs[i].selected) {
				current = li;
				tg.addClass(current, "current");
			}

			li.onclick = function() {
				chrome.tabs.update(this.tabId, { selected : true });
				tg.removeClass(current, "current");
				current = this;
				tg.addClass(current, "current");
			};
			li.onmouseover = function() {
				showActions(this);
			};
			li.onmouseout = function() {
				hideActions(this);
			}
			list.appendChild(li);
		}
		document.getElementById("field").onkeyup = function() {
			if (typing == null) {
				typing = setTimeout(refresh, TYPING_DELAY);
			}
			else {
				clearTimeout(typing);
				typing = setTimeout(refresh, TYPING_DELAY);
			}
		};
	});

	document.getElementById("field").focus();
}
function showActions(tab) {
	tg.addClass(tab, "hover");
}
function hideActions(tab) {
	tg.removeClass(tab, "hover");
}
/* Refresh the tab list after the delay */
function refresh() {
	typing = null;
	var list = document.getElementById("list");
	var item = list.firstChild;
	var field = document.getElementById("field");
	var exp = null;
	if (field.value != null && field.value.replace(/^\s*/,"").length > 0)
		exp = field.value;
	var re = exp != null ? new RegExp(exp, "i") : null;
	while (item != null) {
		if (re != null && !re.test(item.firstChild.url) && !re.test(item.firstChild.innerHTML)) {
			item.style.display = "none";
		}
		else {
			item.style.display = "block";
		}
		item = item.nextSibling;
	}
}
/* TODO Will need to escape the string for regular expressions */
function escapeString(str) {
}

function createLink(icon, title, url) {
	var d = document.createElement("div");
	if (icon != null) {
		var i = document.createElement("img");
		i.setAttribute("class", "favicon");
		i.setAttribute("src", icon);
		d.appendChild(i);
	}

	d.appendChild(document.createTextNode(title));
	d.setAttribute("class", "label");
	d.url = url;
	return d;
}

function createDescription(desc) {
	var p = document.createElement("p");
	p.setAttribute("class", "description");
	p.innerHTML = desc;
	return p;
}

/*
Create actions for tab items
*/
function createActions() {
	var actionContainer = document.createElement("ul");
	actionContainer.setAttribute("class", "actions");
	var action = document.createElement("li");
	var actionTag = document.createElement("div");
	actionTag.setAttribute("class", "close");
	action.appendChild(actionTag);
	actionContainer.appendChild(action);
	return actionContainer;
	
}

</script>
<body onload="load()">
<div id="content">
<div id="search">
<input id="field">
</div>
<div class="scrollable" >
<ul id="list"></ul>
</div>
</div>
</body>
</html>
